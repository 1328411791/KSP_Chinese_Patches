// ------ Sort the station contracts ------
@CONTRACT_TYPE[StationCoreCombined]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 00.StationCore
}
@CONTRACT_TYPE[BasePopulation]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 01.00.BasePopulation
}
@CONTRACT_TYPE[CrewRotation]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 01.01.CrewRotation
}
@CONTRACT_TYPE[ExtraCrewCapacity]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 01.02.ExtraCrewCapacity
}
@CONTRACT_TYPE[ScienceLab]:NEEDS[ContractPacks/KerbinSpaceStation,!StationScience,!Kerbalism]
{
    sortKey = 02.00.ScienceLab
}
@CONTRACT_TYPE[Laboratory]:NEEDS[ContractPacks/KerbinSpaceStation,Kerbalism]
{
    sortKey = 02.01.Laboratory
}
@CONTRACT_TYPE[ResearchLab]:NEEDS[ContractPacks/KerbinSpaceStation,StationScience]
{
    sortKey = 02.02.00.ResearchLab
}
@CONTRACT_TYPE[Cyclotron]:NEEDS[ContractPacks/KerbinSpaceStation,StationScience]
{
    sortKey = 02.02.01.Cyclotron
}
@CONTRACT_TYPE[Spectrometron]:NEEDS[ContractPacks/KerbinSpaceStation,StationScience]
{
    sortKey = 02.02.02.Spectrometron
}
@CONTRACT_TYPE[ZoologyBay]:NEEDS[ContractPacks/KerbinSpaceStation,StationScience]
{
    sortKey = 02.02.03.ZoologyBay
}
@CONTRACT_TYPE[ScienceExperimentModule]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 03.00.ScienceExperimentModule
}
@CONTRACT_TYPE[SurfaceSample]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 03.01.SurfaceSample
}
@CONTRACT_TYPE[MedicalEmergency]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 04.00.MedicalEmergency
}
@CONTRACT_TYPE[Evacuate]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 04.01.Evacuate
}
@CONTRACT_TYPE[ReturnCrew]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 04.02.ReturnCrew
}
@CONTRACT_TYPE[PayloadSpecialist]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 05.01.PayloadSpecialist
}
@CONTRACT_TYPE[RepairFaultyModule]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 05.02.RepairFaultyModule
}
@CONTRACT_TYPE[ReplaceFaultyModule]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 05.03.ReplaceFaultyModule
}
@CONTRACT_TYPE[LSResupply]:NEEDS[ContractPacks/KerbinSpaceStation,TACLifeSupport|USILifeSupport|IFILifeSupport|Kerbalism|Snacks]
{
    sortKey = 06.00.LSResupply
}


// ------ Sort the base contracts ------
@CONTRACT_TYPE[BaseScan]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 10.00.BaseScan
}
@CONTRACT_TYPE[BaseRover]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 10.01.BaseRover
}
@CONTRACT_TYPE[BaseCreate]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 10.02.BaseCreate
}
@CONTRACT_TYPE[BaseCrewRotation]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 11.01.BaseCrewRotation
}
@CONTRACT_TYPE[BaseExpansion]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 11.02.BaseExpansion
}
@CONTRACT_TYPE[BaseScience]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 12.00.BaseScience
}
@CONTRACT_TYPE[BaseCommsLost]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    sortKey = 15.00.BaseCommsLost
}
@CONTRACT_TYPE[BaseResupply]:NEEDS[ContractPacks/KerbinSpaceStation,TACLifeSupport|USILifeSupport|IFILifeSupport|Kerbalism|Snacks]
{
    sortKey = 16.00.BaseResupply
}
@CONTRACT_TYPE[BaseSelfSufficiency]:NEEDS[ContractPacks/KerbinSpaceStation,TACLifeSupport|USILifeSupport|Snacks]
{
    sortKey = 16.01.BaseSelfSufficiency
}


// ------ 原合同包的最大活跃合同个数太小了，根据合同类型增加 ------
// 合同包 的 最大活跃合同个数 = 已到达天体数 * 2 + 2
@CONTRACT_GROUP[BasesandStations]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    @maxSimultaneous = Max(3, ReachedBodies().Count() * 2 + 2)

    DATA
    {
        type = List<Vessel>
        hidden = true

        base_list = AllVessels().Where(v => v.VesselType() == Base && v.IsLanded())
        station_list = AllVessels().Where(v => v.VesselType() == Station && v.IsOrbiting())
    }
    DATA
    {
        type = List<CelestialBody>
        hidden = true

        reached_and_deployed_base_body_list = ReachedBodies().Where(rb => @base_list.Where(v => v.CelestialBody() == rb).Count() > 0)
        reached_and_deployed_station_body_list = ReachedBodies().Where(rb => @station_list.Where(v => v.CelestialBody() == rb).Count() > 0)
    }
    DATA
    {
        type = int
        hidden = true

        reached_and_deployed_base_body_count = @reached_and_deployed_base_body_list.Count()
        reached_and_deployed_station_body_count = @reached_and_deployed_station_body_list.Count()
        reached_but_no_base_body_count = ReachedBodies().Count() - @reached_and_deployed_base_body_count
        reached_but_no_station_body_count = ReachedBodies().Count() - @reached_and_deployed_station_body_count
    }
}
// 基地创建合同 的 最大活跃合同个数 = 已到达但没有部署基地的天体个数 + 1
@CONTRACT_TYPE[BaseRover,BaseScan,BaseCreate]
{
    @maxSimultaneous = Max(2, @BasesandStations:reached_but_no_base_body_count + 1)
}
// 必须发射新载具的基地合同 的 最大活跃合同个数 = 已到达且部署了基地的天体个数
@CONTRACT_TYPE[BaseExpansion,BaseScience,BaseSelfSufficiency]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    @maxSimultaneous = Max(2, @BasesandStations:reached_and_deployed_base_body_count)
}
// 必须返回母星的基地合同 的 最大活跃合同个数 = 已到达且部署了基地的天体个数
@CONTRACT_TYPE[BaseCrewRotation]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    @maxSimultaneous = Max(2, @BasesandStations:reached_and_deployed_base_body_count)
}
// 其他基地合同 的 最大活跃合同个数 = 2
@CONTRACT_TYPE[BasePopulation,BaseCommsLost,BaseResupply]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    @maxSimultaneous = 2
}
// 空间站创建合同 的 最大活跃合同个数 = 已到达但没有部署空间站的天体个数 + 1
@CONTRACT_TYPE[StationCoreCombined]
{
    @maxSimultaneous = Max(2, @BasesandStations:reached_but_no_station_body_count + 1)
}
// 必须发射新载具的空间站合同 的 最大活跃合同个数 = 已到达且部署了空间站的天体个数
@CONTRACT_TYPE[ExtraCrewCapacity,ScienceLab,Laboratory,ResearchLab,Cyclotron,Spectrometron,ZoologyBay,PayloadSpecialist,ReplaceFaultyModule,LSResupply]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    @maxSimultaneous = Max(2, @BasesandStations:reached_and_deployed_station_body_count)
}
// 必须返回母星的空间站合同 的 最大活跃合同个数 = 已到达且部署了空间站的天体个数
@CONTRACT_TYPE[CrewRotation,ScienceExperimentModule,MedicalEmergency]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    @maxSimultaneous = Max(2, @BasesandStations:reached_and_deployed_station_body_count)
}
// 其他空间站合同 的 最大活跃合同个数 = 2
@CONTRACT_TYPE[SurfaceSample,Evacuate,ReturnCrew,RepairFaultyModule]:NEEDS[ContractPacks/KerbinSpaceStation]
{
    @maxSimultaneous = 2
}


// 2014-2-17：以下修复已向mod作者提交，但因为作者一直没有合并我的PR，所以在这里修复。如果作者更新了mod，应将以下部分删去
// （不删会使太阳能电池板的相关要求多显示一行，但不会影响游戏运行）
@CONTRACT_TYPE[StationCoreCombined]:NEEDS[ContractPacks/KerbinSpaceStation]:FIRST
{
    @PARAMETER[NewStation]
    {
        @PARAMETER[RTGSolar]
        {
            @PARAMETER:HAS[#partModule[ModuleDeployableSolarPanel]]
            {
                @name = PartValidationSolar
            }
            @PARAMETER:HAS[#partModule[ModuleGenerator]]
            {
                @name = PartValidationRTG
            }
            @PARAMETER:HAS[#partModule[KopernicusSolarPanel]]:NEEDS[Kopernicus]
            {
                @name = PartValidationSolar
            }
        }
    }
}
@CONTRACT_TYPE[ReplaceFaultyModule]:NEEDS[ContractPacks/KerbinSpaceStation]:FIRST
{
    @PARAMETER[PowerModule]
    {
        @PARAMETER[RTGSolar]
        {
            title = Have one of the following power generators
            @PARAMETER:HAS[#partModule[ModuleCurvedSolarPanel]]:NEEDS[NearFutureSolar]
            {
                @name = PartValidationNearFutureSolar
            }
            PARAMETER:NEEDS[Kopernicus]
            {
                name = PartValidationSolar
                type = PartValidation
                title = 1 or more solar panels
                hideChildren = true
                partModule = KopernicusSolarPanel
                minCount = 1
            }
        }

    }
}
@CONTRACT_TYPE[BaseCreate]:NEEDS[ContractPacks/KerbinSpaceStation]:FIRST
{
    @PARAMETER[All]
    {
        @PARAMETER[Any]
        {
            @hideChildren = false
            PARAMETER:NEEDS[Kopernicus]
            {
                name = Solar
                title = 1 or more solar panels
                type = PartValidation
                hideChildren = true
                partModule = KopernicusSolarPanel
                minCount = 1
            }
        }
    }
}
@CONTRACT_TYPE[BaseCrewRotation]:NEEDS[ContractPacks/KerbinSpaceStation]:FIRST
{
    @maxExpiry = 7
}
